{% comment %}
  Dynamic Product Info Section for Home Page
  Pulls product data from settings
{% endcomment %}

{%- assign product_handle = section.settings.product -%}
{%- if product_handle != blank -%}
  {%- assign product = all_products[product_handle] -%}
{%- endif -%}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<!-- Product Info Section -->
<section class="product_info_section bg-white pt-8 sm:pt-12 md:pt-16 pb-12 sm:pb-16 md:pb-20 section-{{ section.id }}-padding">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">


    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 sm:gap-12 lg:gap-16">

      <!-- Left: Product Images -->
      <div class="relative order-1 lg:order-1 w-full">

        <!-- Sale Badge -->
        {%- if product.compare_at_price > product.price -%}
          {%- assign discount_percentage = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round -%}
          <div class="absolute top-4 left-4 z-20 bg-red-500 text-white px-3 py-1 rounded-full text-xs sm:text-sm font-bold">
            {{ 'products.product.sale_badge' | t: percentage: discount_percentage }}
          </div>
        {%- endif -%}

        <!-- Main Image Gallery -->
        <div class="group relative w-full aspect-[4/5] sm:aspect-square overflow-hidden rounded-xl bg-gray-100 mb-4 border-2 border-gray-200">
          {%- if product.featured_media -%}
            {%- for media in product.media -%}
              <div class="slider-image absolute inset-0 transition-opacity duration-700 ease-in-out" data-slide="{{ forloop.index }}" style="opacity: {% if forloop.first %}1{% else %}0{% endif %};">
                {% render 'product-media', media: media, class: 'w-full h-full object-contain' %}
              </div>
            {%- endfor -%}
          {%- else -%}
            <div class="slider-image absolute inset-0 transition-opacity duration-700 ease-in-out" style="opacity: 1;">
              {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-contain placeholder' }}
            </div>
          {%- endif -%}

          <!-- Navigation Arrows for multiple images -->
          {%- if product.media.size > 1 -%}
            <button onclick="changeSlide(-1)" class="absolute left-3 top-1/2 -translate-y-1/2 bg-white/95 hover:bg-white text-slate-800 p-2.5 rounded-full shadow-lg transition-all duration-300 ease-in-out opacity-0 group-hover:opacity-100 hover:scale-110" aria-label="{{ 'products.product.previous_image' | t }}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <button onclick="changeSlide(1)" class="absolute right-3 top-1/2 -translate-y-1/2 bg-white/95 hover:bg-white text-slate-800 p-2.5 rounded-full shadow-lg transition-all duration-300 ease-in-out opacity-0 group-hover:opacity-100 hover:scale-110" aria-label="{{ 'products.product.next_image' | t }}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          {%- endif -%}
        </div>

        <!-- Thumbnail Images -->
        {%- if product.media.size > 1 -%}
          <div class="flex gap-2 sm:gap-3">
            {%- for media in product.media -%}
              <button onclick="showSlide({{ forloop.index }})" class="{% if product.media.size <= 4 %}w-1/4{% else %}flex-1 min-w-0{% endif %} h-16 sm:h-20 rounded-lg overflow-hidden border-2 {% if forloop.first %}border-slate-600{% else %}border-transparent hover:border-slate-600{% endif %} transition" data-thumbnail="{{ forloop.index }}">
                {% render 'product-media', media: media, class: 'w-full h-full object-cover' %}
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}

        <!-- Trust Badges -->
        <div class="mt-6 grid grid-cols-3 gap-4">
          <div class="flex flex-col items-center text-center p-3 bg-slate-50 rounded-lg">
            <svg class="w-8 h-8 text-slate-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            <span class="text-xs font-semibold text-slate-700">{{ 'products.product.trust_badges.warranty' | t }}</span>
          </div>
          <div class="flex flex-col items-center text-center p-3 bg-slate-50 rounded-lg">
            <svg class="w-8 h-8 text-slate-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-xs font-semibold text-slate-700">{{ 'products.product.trust_badges.free_shipping' | t }}</span>
          </div>
          <div class="flex flex-col items-center text-center p-3 bg-slate-50 rounded-lg">
            <svg class="w-8 h-8 text-slate-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="text-xs font-semibold text-slate-700">{{ 'products.product.trust_badges.returns' | t }}</span>
          </div>
        </div>
      </div>

      <!-- Right: Product Info -->
      <div class="flex flex-col order-2 lg:order-2">
        {%- assign product_form_id = 'product-form-' | append: section.id -%}

        <!-- Product Title -->
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 leading-tight">
          {{ product.title | escape }}
        </h1>

        <!-- Rating & Reviews -->
        {%- assign reviews_list = product.metafields.custom.product_reviews.value -%}

        {%- comment -%} Calculate review count and average rating from metaobject list {%- endcomment -%}
        {%- assign review_count = 0 -%}
        {%- assign total_rating = 0 -%}

        {%- if reviews_list != blank -%}
          {%- assign review_count = reviews_list.count -%}
          {%- for review in reviews_list -%}
            {%- assign current_rating = review.rating | plus: 0 -%}
            {%- assign total_rating = total_rating | plus: current_rating -%}
          {%- endfor -%}

          {%- if review_count > 0 -%}
            {%- assign average_rating = total_rating | times: 1.0 | divided_by: review_count | round: 1 -%}
          {%- else -%}
            {%- assign average_rating = 0 -%}
          {%- endif -%}
        {%- else -%}
          {%- assign average_rating = 0 -%}
        {%- endif -%}

        {%- if review_count > 0 -%}
          <div class="flex items-center gap-3 mt-3">
            <div class="flex items-center">
              {%- assign full_stars = average_rating | floor -%}
              {%- assign has_half_star = average_rating | minus: full_stars | at_least: 0.5 -%}
              {%- assign next_star = full_stars | plus: 1 -%}

              {%- for i in (1..5) -%}
                {%- if i <= full_stars -%}
                  <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 15.27L16.18 19l-1.64-7.03L20 7.24l-7.19-.61L10 0 7.19 6.63 0 7.24l5.46 4.73L3.82 19 10 15.27z"></path>
                  </svg>
                {%- elsif i == next_star and has_half_star > 0 -%}
                  <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-opacity=".3" d="M10 15.27L16.18 19l-1.64-7.03L20 7.24l-7.19-.61L10 0 7.19 6.63 0 7.24l5.46 4.73L3.82 19 10 15.27z"></path>
                  </svg>
                {%- else -%}
                  <svg class="w-5 h-5 text-slate-300" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 15.27L16.18 19l-1.64-7.03L20 7.24l-7.19-.61L10 0 7.19 6.63 0 7.24l5.46 4.73L3.82 19 10 15.27z"></path>
                  </svg>
                {%- endif -%}
              {%- endfor -%}
            </div>
            <span class="text-sm text-gray-600 font-medium">{{ average_rating }}</span>
            <a href="#reviews-tab" onclick="event.preventDefault(); const reviewBtn = document.querySelector('button[onclick*=reviews-tab]'); if(reviewBtn) { reviewBtn.click(); document.getElementById('reviews-tab').scrollIntoView({behavior: 'smooth', block: 'start'}); }" class="text-sm text-blue-600 hover:text-blue-800 underline cursor-pointer transition">{{ 'products.product.reviews_count' | t: count: review_count }}</a>
          </div>
        {%- endif -%}

        <!-- Price -->
        <div class="flex items-baseline gap-3 mt-4" id="price-{{ section.id }}" role="status">
          {%- assign compare_at_price = product.selected_or_first_available_variant.compare_at_price -%}
          {%- assign price = product.selected_or_first_available_variant.price -%}

          <span class="text-3xl sm:text-4xl font-bold text-slate-800">{{ price | money }}</span>

          {%- if compare_at_price > price -%}
            <span class="text-xl sm:text-2xl text-gray-400 line-through">{{ compare_at_price | money }}</span>
            {%- assign discount_percentage = compare_at_price | minus: price | times: 100.0 | divided_by: compare_at_price | round -%}
            <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-sm font-semibold">{{ discount_percentage }}% OFF</span>
          {%- endif -%}
        </div>

        <!-- Stock Status -->
        {%- if section.settings.show_stock_status -%}
          {%- if product.selected_or_first_available_variant.inventory_management == 'shopify' -%}
            <div class="flex items-center gap-2 mt-3">
              {%- if product.selected_or_first_available_variant.inventory_quantity > 0 -%}
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                <span class="text-sm text-green-700 font-medium">
                  {%- if section.settings.show_inventory_quantity and product.selected_or_first_available_variant.inventory_quantity <= section.settings.low_stock_threshold -%}
                    {{ 'products.product.stock.low_stock' | t: quantity: product.selected_or_first_available_variant.inventory_quantity }}
                  {%- else -%}
                    {{ section.settings.in_stock_text | default: 'products.product.stock.in_stock' | t }}
                  {%- endif -%}
                </span>
              {%- else -%}
                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                <span class="text-sm text-red-700 font-medium">{{ section.settings.out_of_stock_text | default: 'products.product.stock.out_of_stock' | t }}</span>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endif -%}

        <!-- Description -->
        {%- if product.description != blank -%}
          <div class="product__description rte text-sm sm:text-base text-gray-700 mt-5 leading-relaxed">
            {{ product.description | truncatewords: 50 }}
          </div>
        {%- endif -%}

        <!-- Key Features -->
        {%- if section.settings.show_features -%}
        <div class="mt-5 space-y-2">
          {%- if section.settings.feature_1 != blank -%}
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-sm text-gray-700">{{ section.settings.feature_1 }}</span>
          </div>
          {%- endif -%}
          {%- if section.settings.feature_2 != blank -%}
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-sm text-gray-700">{{ section.settings.feature_2 }}</span>
          </div>
          {%- endif -%}
          {%- if section.settings.feature_3 != blank -%}
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-sm text-gray-700">{{ section.settings.feature_3 }}</span>
          </div>
          {%- endif -%}
          {%- if section.settings.feature_4 != blank -%}
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-sm text-gray-700">{{ section.settings.feature_4 }}</span>
          </div>
          {%- endif -%}
        </div>
        {%- endif -%}

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 mt-8">
          <form method="post" action="/cart/add" id="product-form-{{ section.id }}" class="flex-1">
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <input type="hidden" name="quantity" value="1">
            <button
              type="submit"
              name="add"
              class="w-full border-2 border-slate-700 text-slate-700 font-bold py-3.5 px-8 rounded-lg hover:bg-slate-50 transition"
            >
              <span class="submit-button-text">{{ 'products.product.buy_now' | t }}</span>
            </button>
          </form>
          <a href="{{ product.url }}" class="flex-1 border-2 border-slate-700 bg-slate-700 text-white font-bold py-3.5 px-8 rounded-lg hover:bg-slate-800 transition text-center flex items-center justify-center">
            View Details
          </a>
        </div>
        <!-- Dynamic Expert Advisor Section -->
      {% render 'advisor-card' %}
      </div>
    </div>
  </div>
</section>

<script>
let currentSlide = 1;
const totalSlides = {{ product.media.size }};

function showSlide(n) {
  if (n > totalSlides) { currentSlide = 1; }
  if (n < 1) { currentSlide = totalSlides; }
  else { currentSlide = n; }

  const slides = document.querySelectorAll('.slider-image');
  const thumbnails = document.querySelectorAll('[data-thumbnail]');

  slides.forEach((slide, index) => {
    slide.style.opacity = (index + 1) === currentSlide ? '1' : '0';
  });

  thumbnails.forEach((thumb, index) => {
    if ((index + 1) === currentSlide) {
      thumb.classList.remove('border-transparent');
      thumb.classList.add('border-slate-600');
    } else {
      thumb.classList.remove('border-slate-600');
      thumb.classList.add('border-transparent');
    }
  });
}

function changeSlide(n) {
  showSlide(currentSlide + n);
}

// Buy Now functionality - Add to cart and redirect to checkout
document.addEventListener('DOMContentLoaded', function() {
  const productForm = document.getElementById('product-form-{{ section.id }}');
  const addingText = {{ 'products.product.adding_to_cart' | t | json }};
  const errorText = {{ 'products.product.add_to_cart_error' | t | json }};

  if (productForm) {
    productForm.addEventListener('submit', function(event) {
      event.preventDefault();

      const formData = new FormData(productForm);
      const submitButton = productForm.querySelector('button[type="submit"]');
      const buttonText = submitButton.querySelector('.submit-button-text');
      const originalText = buttonText.textContent;

      // Disable button and show loading state
      submitButton.disabled = true;
      buttonText.textContent = addingText;

      // Add product to cart
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: formData.get('id'),
          quantity: parseInt(formData.get('quantity'))
        })
      })
      .then(response => response.json())
      .then(data => {
        // Redirect to checkout
        window.location.href = '/checkout';
      })
      .catch(error => {
        console.error('Error:', error);
        // Re-enable button and restore text
        submitButton.disabled = false;
        buttonText.textContent = originalText;
        alert(errorText);
      });
    });
  }
});

</script>

{% schema %}
{
  "name": "Loopzo Product Info",
  "tag": "section",
  "class": "section",
  "limit": 1,
  "settings": [
    {
      "type": "header",
      "content": "Product Selection"
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Select a product to display on the home page"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_info",
      "default": true,
      "label": "t:sections.main-product.settings.enable_sticky_info.label"
    },
    {
      "type": "header",
      "content": "t:sections.main-product.settings.header__stock_status"
    },
    {
      "type": "checkbox",
      "id": "show_stock_status",
      "label": "t:sections.main-product.settings.show_stock_status.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_inventory_quantity",
      "label": "t:sections.main-product.settings.show_inventory_quantity.label",
      "default": true,
      "info": "t:sections.main-product.settings.show_inventory_quantity.info"
    },
    {
      "type": "range",
      "id": "low_stock_threshold",
      "min": 1,
      "max": 50,
      "step": 1,
      "label": "t:sections.main-product.settings.low_stock_threshold.label",
      "default": 10,
      "info": "t:sections.main-product.settings.low_stock_threshold.info"
    },
    {
      "type": "text",
      "id": "in_stock_text",
      "label": "t:sections.main-product.settings.in_stock_text.label",
      "default": "In Stock - Ready to Ship"
    },
    {
      "type": "text",
      "id": "out_of_stock_text",
      "label": "t:sections.main-product.settings.out_of_stock_text.label",
      "default": "Out of Stock"
    },
    {
      "type": "header",
      "content": "t:sections.main-product.settings.header__product_features"
    },
    {
      "type": "checkbox",
      "id": "show_features",
      "label": "t:sections.main-product.settings.show_features.label",
      "default": true
    },
    {
      "type": "text",
      "id": "feature_1",
      "label": "t:sections.main-product.settings.feature_1.label",
      "default": "Custom-made to your specifications"
    },
    {
      "type": "text",
      "id": "feature_2",
      "label": "t:sections.main-product.settings.feature_2.label",
      "default": "Premium Dutch craftsmanship"
    },
    {
      "type": "text",
      "id": "feature_3",
      "label": "t:sections.main-product.settings.feature_3.label",
      "default": "Electric and manual options available"
    },
    {
      "type": "text",
      "id": "feature_4",
      "label": "t:sections.main-product.settings.feature_4.label",
      "default": "Free test ride included"
    },
    {
      "type": "header",
      "content": "t:sections.main-product.settings.header__padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.main-product.settings.padding_top.label",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.main-product.settings.padding_bottom.label",
      "default": 80
    }
  ],
  "presets": [
    {
      "name": "Loopzo Product Info",
      "category": "Loopzo"
    }
  ]
}
{% endschema %}